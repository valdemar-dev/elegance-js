(()=>{window.__name=a=>a;globalThis.pd||(globalThis.pd={});const L=new DOMParser,D=new XMLSerializer,k=new Map,$=window.location,h=document;let m=[];const A=Array.from,v=a=>!a.endsWith("/")||a==="/"?a:a.slice(0,-1);let P=v($.pathname);const M=a=>{const r={subjects:a.map(t=>{const n={...t,observers:new Map};return n.signal=()=>{for(const o of n.observers.values())try{o(n.value)}catch{continue}},n}),get:(t,n)=>n?pd[n].get(t):r.subjects.find(o=>o.id===t),getAll:t=>t?.map(n=>n.bind?pd[n.bind].get(n.id):r.get(n.id)),observe:(t,n,o)=>{t.observers.delete(o),t.observers.set(o,n)}};return r},B=(a=[],r)=>{const t=new URL($.href);t.pathname=v(t.pathname);const n=t.pathname;history.replaceState(null,"",t.href);let o=pd[n];if(pd===void 0)return;for(const[e,c]of Object.entries(o.binds||{})){if(!pd[e]){pd[e]=M(c);continue}const l=pd[e],u=c;for(const f of u)l.get(f.id)||pd[e].subjects.push(f)}let i=o.stateManager;i||(i=M(o.state||[]),o.stateManager=i);for(const e of i.subjects)e.observers=new Map;for(const e of o.ooa||[]){const c=h.querySelector(`[key="${e.key}"]`);let l={};for(const{id:u,bind:f}of e.refs){const d=i.get(u,f);l[d.id]=d.value;const b=y=>{l[u]=y;try{const S=e.update(...Object.values(l));let j=e.attribute==="class"?"className":e.attribute;c[j]=S}catch{return}};b(d.value);try{i.observe(d,b,e.key)}catch{return}}}for(const e of o.soa||[]){const c=h.querySelector(`[key="${e.key}"]`),l=i.get(e.id,e.bind);if(typeof l.value=="function")try{c[e.attribute]=u=>l.value(i,u)}catch{return}else c[e.attribute]=l.value}const w=o.lh;for(const e of w||[]){const c=e.bind;if(c!==void 0&&r&&!r.includes(`${c}`))continue;const l=e.fn;try{let u;l.constructor.name==="AsyncFunction"?l(i).then(d=>{d&&m.push({cleanupFunction:d,bind:`${c}`})}):(u=l(i),u&&m.push({cleanupFunction:u,bind:`${c}`}))}catch{return}}k.set(P,D.serializeToString(h))},T=async a=>{const r=v(a.pathname);if(k.has(r))return L.parseFromString(k.get(r),"text/html");const t=await fetch(a);if(!t.ok)return;const n=L.parseFromString(await t.text(),"text/html"),o=r==="/"?r+"page_data.js":r+"/page_data.js";if(!pd[r]){const i=await import(o);pd[r]=i}return k.set(r,D.serializeToString(n)),n},x=async(a,r=!0)=>{const t=new URL(a),n=v(t.pathname);let o=await T(t);if(!o||n===P)return;const i=A(h.querySelectorAll("div[bp]")),w=i.map(s=>s.getAttribute("bp")),e=A(o.querySelectorAll("div[bp]")),c=e.map(s=>s.getAttribute("bp")),l=(s,p)=>{let g=0;const C=Math.min(s.length,p.length);for(;g<C&&s[g].getAttribute("bp")===p[g].getAttribute("bp");)g++;return g>0?[s[g-1],p[g-1]]:[document.body,o.body]},[u,f]=l(i,e),d=[],b=u.getAttribute("key"),y=s=>{const p=s.getAttribute("key");if(p&&d.push(p),!(p===b||!b))for(const g of A(s.children))y(g)};y(h.body);const S=w.filter(s=>!c.includes(s)),j=c.filter(s=>!w.includes(s));for(const s of[...m]){const p=s.bind;if(p.length<1||S.includes(p)){try{s.cleanupFunction()}catch{return}m.splice(m.indexOf(s),1)}}u.replaceWith(f),h.head.replaceWith(o.head),r&&history.pushState(null,"",t.href),P=n,t.hash&&h.getElementById(t.hash.slice(1))?.scrollIntoView(),B(d,j)};window.onpopstate=async a=>{a.preventDefault();const r=a.target;await x(r.location.href,!1),history.replaceState(null,"",r.location.href)};globalThis.client={navigateLocally:x,fetchPage:T,currentPage:P,sanitizePathname:v,getReference:a=>document.querySelector(`[ref="${a}"]`)};try{B()}catch{}})();
