(()=>{window.__name=o=>o;const L=new DOMParser,D=new XMLSerializer,S=new Map,$=window.location,b=document;let m=[];const A=Array.from,y=o=>!o.endsWith("/")||o==="/"?o:o.slice(0,-1);let k=y($.pathname);const M=o=>{const s={subjects:o.map(t=>{const n={...t,observers:new Map};return n.signal=()=>{for(const a of n.observers.values())a(n.value)},n}),get:(t,n)=>n?pd[n].get(t):s.subjects.find(a=>a.id===t),getAll:t=>t?.map(n=>n.bind?pd[n.bind].get(n.id):s.get(n.id)),observe:(t,n,a)=>{t.observers.delete(a),t.observers.set(a,n)}};return s},B=(o=[],s)=>{const t=new URL($.href);t.pathname=y(t.pathname);const n=t.pathname;history.replaceState(null,"",t.href);let a=pd[n];if(!a)return;for(const[e,i]of Object.entries(a.binds||{})){if(!pd[e]){pd[e]=M(i);continue}const c=pd[e],u=i;for(const f of u)c.get(f.id)||pd[e].subjects.push(f)}let l=a.stateManager;l||(l=M(a.state),a.stateManager=l);for(const e of l.subjects)e.observers=new Map;for(const e of a.ooa||[]){const i=b.querySelector(`[key="${e.key}"]`);let c={};for(const{id:u,bind:f}of e.refs){const d=l.get(u,f);c[d.id]=d.value;const h=w=>{c[u]=w;const j=e.update(...Object.values(c));let P=e.attribute==="class"?"className":e.attribute;i[P]=j};h(d.value),l.observe(d,h,e.key)}}for(const e of a.soa||[]){const i=b.querySelector(`[key="${e.key}"]`),c=l.get(e.id,e.bind);typeof c.value=="function"?i[e.attribute]=u=>c.value(l,u):i[e.attribute]=c.value}const v=a.lh;for(const e of v||[]){const i=e.bind;if(i!==void 0&&s&&!s.includes(`${i}`))continue;const c=e.fn;let u;c.constructor.name==="AsyncFunction"?c(l).then(d=>{d&&m.push({cleanupFunction:d,bind:`${i}`})}):(u=c(l),u&&m.push({cleanupFunction:u,bind:`${i}`}))}S.set(k,D.serializeToString(b))},x=async o=>{const s=y(o.pathname);if(S.has(s))return L.parseFromString(S.get(s),"text/html");const t=await fetch(o);if(!t.ok)return;const n=L.parseFromString(await t.text(),"text/html"),a=s==="/"?s+"page_data.js":s+"/page_data.js";return pd[s]||await import(a),S.set(s,D.serializeToString(n)),n},C=async(o,s=!0)=>{const t=new URL(o),n=y(t.pathname);let a=await x(t);if(!a||n===k)return;const l=A(b.querySelectorAll("div[bp]")),v=l.map(r=>r.getAttribute("bp")),e=A(a.querySelectorAll("div[bp]")),i=e.map(r=>r.getAttribute("bp")),c=(r,p)=>{let g=0;const E=Math.min(r.length,p.length);for(;g<E&&r[g].getAttribute("bp")===p[g].getAttribute("bp");)g++;return g>0?[r[g-1],p[g-1]]:[document.body,a.body]},[u,f]=c(l,e),d=[],h=u.getAttribute("key"),w=r=>{const p=r.getAttribute("key");if(p&&d.push(p),!(p===h||!h))for(const g of A(r.children))w(g)};w(b.body);const j=v.filter(r=>!i.includes(r)),P=i.filter(r=>!v.includes(r));for(const r of[...m]){const p=r.bind;(p.length<1||j.includes(p))&&(r.cleanupFunction(),m.splice(m.indexOf(r),1))}u.replaceWith(f),b.head.replaceWith(a.head),s&&history.pushState(null,"",t.href),k=n,t.hash&&b.getElementById(t.hash.slice(1))?.scrollIntoView(),B(d,P)};window.onpopstate=async o=>{o.preventDefault();const s=o.target;await C(s.location.href,!1),history.replaceState(null,"",s.location.href)};globalThis.client={navigateLocally:C,fetchPage:x,currentPage:k,sanitizePathname:y,getReference:o=>document.querySelector(`[ref="${o}"]`)};B();})();
