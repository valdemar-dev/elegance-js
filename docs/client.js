(()=>{window.__name=o=>o;const L=new DOMParser,D=new XMLSerializer,S=new Map,$=window.location,f=document;let v=[];const A=Array.from,m=o=>!o.endsWith("/")||o==="/"?o:o.slice(0,-1);let k=m($.pathname);const M=o=>{const s={subjects:o.map(t=>{const n={...t,observers:new Map};return n.signal=()=>{for(const a of n.observers.values())a(n.value)},n}),get:(t,n)=>n?pd[n].get(t):s.subjects.find(a=>a.id===t),getAll:t=>t?.map(n=>n.bind?pd[n.bind].get(n.id):s.get(n.id)),observe:(t,n,a)=>{t.observers.delete(a),t.observers.set(a,n)}};return s},B=(o=[],s)=>{const t=new URL($.href);t.pathname=m(t.pathname);const n=t.pathname;history.replaceState(null,"",t.href);let a=pd[n];if(!a)return;for(const[e,i]of Object.entries(a.binds||{})){if(!pd[e]){pd[e]=M(i);continue}const c=pd[e],u=i;for(const b of u)c.get(b.id)||pd[e].subjects.push(b)}let l=a.stateManager;l||(l=M(a.state),a.stateManager=l);for(const e of l.subjects)e.observers=new Map;for(const e of a.ooa||[]){const i=f.querySelector(`[key="${e.key}"]`);let c={};for(const{id:u,bind:b}of e.refs){const g=l.get(u,b);c[g.id]=g.value;const h=w=>{c[u]=w;const j=e.update(...Object.values(c));let P=e.attribute==="class"?"className":e.attribute;i[P]=j};h(g.value),l.observe(g,h,e.key)}}for(const e of a.soa||[]){const i=f.querySelector(`[key="${e.key}"]`),c=l.get(e.id,e.bind);typeof c.value=="function"?i[e.attribute]=u=>c.value(l,u):i[e.attribute]=c.value}const y=a.lh;for(const e of y||[]){const i=e.bind;if(i!==void 0&&s&&!s.includes(`${i}`))continue;const c=e.fn,u=c(l);u&&v.push({cleanupFunction:u,bind:`${i}`})}S.set(k,D.serializeToString(f))},x=async o=>{const s=m(o.pathname);if(S.has(s))return L.parseFromString(S.get(s),"text/html");const t=await fetch(o);if(!t.ok)return;const n=L.parseFromString(await t.text(),"text/html"),a=s==="/"?s+"page_data.js":s+"/page_data.js";return pd[s]||await import(a),S.set(s,D.serializeToString(n)),n},C=async(o,s=!0)=>{const t=new URL(o),n=m(t.pathname);let a=await x(t);if(!a||n===k)return;const l=A(f.querySelectorAll("div[bp]")),y=l.map(r=>r.getAttribute("bp")),e=A(a.querySelectorAll("div[bp]")),i=e.map(r=>r.getAttribute("bp")),c=(r,d)=>{let p=0;const E=Math.min(r.length,d.length);for(;p<E&&r[p].getAttribute("bp")===d[p].getAttribute("bp");)p++;return p>0?[r[p-1],d[p-1]]:[document.body,a.body]},[u,b]=c(l,e),g=[],h=u.getAttribute("key"),w=r=>{const d=r.getAttribute("key");if(d&&g.push(d),!(d===h||!h))for(const p of A(r.children))w(p)};w(f.body);const j=y.filter(r=>!i.includes(r)),P=i.filter(r=>!y.includes(r));for(const r of[...v]){const d=r.bind;(d.length<1||j.includes(d))&&(r.cleanupFunction(),v.splice(v.indexOf(r),1))}u.replaceWith(b),f.head.replaceWith(a.head),s&&history.pushState(null,"",t.href),k=n,t.hash&&f.getElementById(t.hash.slice(1))?.scrollIntoView(),B(g,P)};window.onpopstate=async o=>{o.preventDefault();const s=o.target;await C(s.location.href,!1),history.replaceState(null,"",s.location.href)};globalThis.client={navigateLocally:C,fetchPage:x,currentPage:k,sanitizePathname:m,getReference:o=>document.querySelector(`[ref="${o}"]`)};B();})();
