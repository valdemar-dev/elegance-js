(()=>{window.__name=a=>a;const L=new DOMParser,D=new XMLSerializer,k=new Map,$=window.location,h=document;let m=[];const A=Array.from,v=a=>!a.endsWith("/")||a==="/"?a:a.slice(0,-1);let j=v($.pathname);const M=a=>{const r={subjects:a.map(t=>{const n={...t,observers:new Map};return n.signal=()=>{for(const o of n.observers.values())try{o(n.value)}catch{continue}},n}),get:(t,n)=>n?pd[n].get(t):r.subjects.find(o=>o.id===t),getAll:t=>t?.map(n=>n.bind?pd[n.bind].get(n.id):r.get(n.id)),observe:(t,n,o)=>{t.observers.delete(o),t.observers.set(o,n)}};return r},B=(a=[],r)=>{const t=new URL($.href);t.pathname=v(t.pathname);const n=t.pathname;history.replaceState(null,"",t.href);let o=pd[n];if(!o)return;for(const[e,i]of Object.entries(o.binds||{})){if(!pd[e]){pd[e]=M(i);continue}const c=pd[e],l=i;for(const f of l)c.get(f.id)||pd[e].subjects.push(f)}let u=o.stateManager;u||(u=M(o.state),o.stateManager=u);for(const e of u.subjects)e.observers=new Map;for(const e of o.ooa||[]){const i=h.querySelector(`[key="${e.key}"]`);let c={};for(const{id:l,bind:f}of e.refs){const d=u.get(l,f);c[d.id]=d.value;const b=y=>{c[l]=y;try{const S=e.update(...Object.values(c));let P=e.attribute==="class"?"className":e.attribute;i[P]=S}catch{return}};b(d.value);try{u.observe(d,b,e.key)}catch{return}}}for(const e of o.soa||[]){const i=h.querySelector(`[key="${e.key}"]`),c=u.get(e.id,e.bind);if(typeof c.value=="function")try{i[e.attribute]=l=>c.value(u,l)}catch{return}else i[e.attribute]=c.value}const w=o.lh;for(const e of w||[]){const i=e.bind;if(i!==void 0&&r&&!r.includes(`${i}`))continue;const c=e.fn;try{let l;c.constructor.name==="AsyncFunction"?c(u).then(d=>{d&&m.push({cleanupFunction:d,bind:`${i}`})}):(l=c(u),l&&m.push({cleanupFunction:l,bind:`${i}`}))}catch{return}}k.set(j,D.serializeToString(h))},x=async a=>{const r=v(a.pathname);if(k.has(r))return L.parseFromString(k.get(r),"text/html");const t=await fetch(a);if(!t.ok)return;const n=L.parseFromString(await t.text(),"text/html"),o=r==="/"?r+"page_data.js":r+"/page_data.js";return pd[r]||await import(o),k.set(r,D.serializeToString(n)),n},C=async(a,r=!0)=>{const t=new URL(a),n=v(t.pathname);let o=await x(t);if(!o||n===j)return;const u=A(h.querySelectorAll("div[bp]")),w=u.map(s=>s.getAttribute("bp")),e=A(o.querySelectorAll("div[bp]")),i=e.map(s=>s.getAttribute("bp")),c=(s,p)=>{let g=0;const E=Math.min(s.length,p.length);for(;g<E&&s[g].getAttribute("bp")===p[g].getAttribute("bp");)g++;return g>0?[s[g-1],p[g-1]]:[document.body,o.body]},[l,f]=c(u,e),d=[],b=l.getAttribute("key"),y=s=>{const p=s.getAttribute("key");if(p&&d.push(p),!(p===b||!b))for(const g of A(s.children))y(g)};y(h.body);const S=w.filter(s=>!i.includes(s)),P=i.filter(s=>!w.includes(s));for(const s of[...m]){const p=s.bind;if(p.length<1||S.includes(p)){try{s.cleanupFunction()}catch{return}m.splice(m.indexOf(s),1)}}l.replaceWith(f),h.head.replaceWith(o.head),r&&history.pushState(null,"",t.href),j=n,t.hash&&h.getElementById(t.hash.slice(1))?.scrollIntoView(),B(d,P)};window.onpopstate=async a=>{a.preventDefault();const r=a.target;await C(r.location.href,!1),history.replaceState(null,"",r.location.href)};globalThis.client={navigateLocally:C,fetchPage:x,currentPage:j,sanitizePathname:v,getReference:a=>document.querySelector(`[ref="${a}"]`)};try{B()}catch{}})();
