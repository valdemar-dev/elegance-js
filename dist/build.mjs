import f from"fs";import a from"path";import O from"esbuild";import{fileURLToPath as H}from"url";var w=e=>{if(typeof e=="string"||typeof e=="number")return e;if(typeof e!="function")throw"Cannot render non-functional elements.";let n=e(),t="";if(t+=`<${n.tag}`,Object.hasOwn(n,"getOptions")){let o=n.getOptions();for(let[s,r]of Object.entries(o))t+=` ${s}="${r}"`}if(!n.children)return t+="/>",t;t+=">";for(let o of n.children)t+=w(o);return t+=`</${n.tag}>`,t},y=({pageURL:e,head:n,renderingMethod:t,serverData:o=null,addPageScriptTag:s=!0})=>{let r='<meta name="viewport" content="width=device-width, initial-scale=1.0">';switch(t){case 1:r+='<script src="/client_ssr.js" defer="true"></script>';break;case 2:r+='<script src="/client_ssg.js" defer="true"></script>';break;case 3:r+='<script src="/client_csr.js" defer="true"></script>';break}s&&(r+=`<script type="module" src="${e===""?"":"/"}${e}/page.js" defer="true"></script>`);let c=n()();for(let d of c.children)r+=w(d);return o&&(r+=o),r};var j=e=>function(){let n={};for(let t of Object.keys(e)){let o=e[t];typeof o=="function"?t.startsWith("on")?n[t]=o:n[t]=o():n[t]=o}return n},x=e=>(n,...t)=>{let o=j(n);return()=>({tag:e,getOptions:o,children:t})},k=e=>(...n)=>()=>({tag:e,getOptions:()=>({}),children:n}),B=e=>n=>{let t=j(n);return()=>({tag:e,getOptions:t,children:[]})},A=["abbr","b","bdi","bdo","cite","code","dfn","em","i","kbd","mark","rp","rt","ruby","s","samp","small","strong","sub","sup","u","wbr"],G=["area","base","br","col","embed","hr","img","input","link","meta","source","track"],U=["a","address","article","aside","audio","blockquote","body","button","canvas","caption","colgroup","data","datalist","dd","del","details","dialog","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","html","iframe","ins","label","legend","li","main","map","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","section","select","summary","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","ul","video","span"],_={},v={},P={};for(let e of U)_[e]=x(e);for(let e of A)v[e]=k(e);for(let e of G)P[e]=B(e);var R={..._,...v,...P};var I=(e,n=e)=>{let t=[],o=f.readdirSync(e,{withFileTypes:!0});for(let s of o)if(s.isDirectory()){let r=a.join(e,s.name),c=a.relative(n,r);t.push(c),t=t.concat(I(r,n))}return t},$=(e,n)=>{let t=e.find(o=>a.parse(o.name).name===n);return t||!1},m=process.cwd(),E=a.join(m,"./.elegance/dist"),V=a.join(m,"./.elegance/server"),W=H(import.meta.url),q=a.dirname(W),b=a.resolve(q,".."),J=a.resolve(b,"./src/client/client_csr.ts"),Q=a.resolve(b,"./src/client/client_ssg.ts"),Y=a.resolve(b,"./src/client/client_ssr.ts"),z=a.resolve(b,"./src/shared/bindServerElements.ts"),K=e=>{let n=[],t=[],o=[...I(e),""];for(let s of o){let r=a.join(m,e,s),c=f.readdirSync(r,{withFileTypes:!0}).filter(p=>p.name.endsWith(".js")||p.name.endsWith(".ts")),d=$(c,"page"),u=$(c,"info");if(!(!d&&!u)){if(u){if(!d)throw"Each info.js/ts file must have an accompanying page.js/ts file."}else throw"Each page.js/ts file must have an accompanying info.js/ts file.";n.push(d),t.push(u)}}return{pageFiles:n,infoFiles:t}},N=(e,n)=>({name:"rename-function-calls",setup(t){t.onLoad({filter:/\.(js|mjs|ts)$/},o=>{let s=f.readFileSync(o.path,"utf8");n==="development"&&console.log(`BUILDING: ${o.path}`);for(let r of e){let c=new RegExp(`(?<!\\.)\\b(${r})\\s*\\(`,"g");s=s.replaceAll(c,`_e.${r}(`)}return{contents:s,loader:o.suffix in["js","mjs"]?"js":"ts"}})}}),X=async e=>{await O.build({bundle:!0,minify:e==="production",drop:e==="production"?["console","debugger"]:void 0,keepNames:!0,entryPoints:[J,Y,Q],outdir:E,format:"esm",platform:"node",plugins:[N(Object.keys(R),e)]})},Z=async(e,n)=>{let t=e.map(o=>`${o.parentPath}/${o.name}`);await O.build({minify:n==="production",drop:n==="production"?["console","debugger"]:void 0,entryPoints:t,bundle:!0,outdir:V,loader:{".js":"js",".ts":"ts"},inject:[z],format:"esm",platform:"node"})},ee=async(e,n)=>{let t=a.join(m,"./.elegance/server"),o=[...I(t),""],s=[];for(let r of o){let c=`${a.join(t,r,"/info.js")}`,d=a.join(m,n,r),u=e.find(C=>C.parentPath===d);if(!u)continue;let p=await import(c),{renderingMethod:S=1,metadata:i,executeOnServer:F,generateMetadata:L=1}=p;if(!i)throw`${r} does not export a function \`metadata\`. Info files must export a \`metadata\` function which resolves into a <head> element.`;if(typeof i!="function")throw`${r} The function \`metadata\` is not a function which resolves into a <head> element.`;s.push({renderingMethod:S,metadata:i,executeOnServer:F??null,generateMetadata:L,pageFilepath:`${u.parentPath}/${u.name}`,pageLocation:r})}return s},te=async(e,n)=>{for(let t of e){if(t.generateMetadata!==1)continue;let o=y({pageURL:t.pageLocation,head:t.metadata,addPageScriptTag:!1,renderingMethod:t.renderingMethod});f.writeFileSync(a.join(E,t.pageLocation,"metadata.html"),o,"utf-8")}},ne=async(e,n)=>{},oe=async(e,n)=>{for(let t of e){if(t.generateMetadata!==1)continue;let o=y({pageURL:t.pageLocation,head:t.metadata,addPageScriptTag:!0,renderingMethod:t.renderingMethod});f.writeFileSync(a.join(E,t.pageLocation,"metadata.html"),o,"utf-8")}},D=e=>`\x1B[38;2;238;184;68m${e}`,re=e=>`\x1B[38;2;0;0;0m${e}`,ie=e=>`\x1B[48;2;238;184;68m${e}`;var h=e=>`\x1B[1m${e}`,se=e=>`\x1B[4m${e}`,g=e=>`\x1B[38;2;255;247;229m${e}`,T=e=>`\x1B[38;2;255;239;204m${e}`,ae=e=>`\x1B[38;2;65;224;108m${e}`,l=(...e)=>console.log(e.map(n=>`${n}\x1B[0m`).join("")),Ie=async({pagesDirectory:e,buildOptions:n,environment:t})=>{l(h(D(" -- Elegance.JS -- "))),l(g(`Beginning build at ${new Date().toLocaleTimeString()}..`)),l(""),t==="production"&&(l(" - ",ie(h(re(" NOTE ")))," : ",g("In production mode, no "),se("console.log() "),g("statements will be shown on the client, and all code will be minified.")),l(""));let o=performance.now(),{pageFiles:s,infoFiles:r}=K(e);await Z(r,t);let c=await ee(s,e),d=c.filter(i=>i.renderingMethod===3),u=c.filter(i=>i.renderingMethod===1),p=c.filter(i=>i.renderingMethod===2);await O.build({entryPoints:[...u.map(i=>i.pageFilepath),...d.map(i=>i.pageFilepath)],minify:t==="production",drop:t==="production"?["console","debugger"]:void 0,bundle:!0,outdir:E,loader:{".js":"js",".ts":"ts"},format:"esm",platform:"node",plugins:[N(Object.keys(R),t)]}),await te(u,t),await oe(d,t),await ne(p,t),await X(t);let S=performance.now();l(h(D(" -- Elegance.JS -- "))),l(g(`Finished build at ${new Date().toLocaleTimeString()}.`)),l(ae(h(`Created ${s.length} pages in ${Math.ceil(S-o)}ms!`))),l(""),l(g("  CSR:"));for(let i of d)l(T(`    - /${i.pageLocation}`));l(g("  SSR:"));for(let i of u)l(T(`    - /${i.pageLocation}`));l(g("  SSG:"));for(let i of p)l(T(`    - /${i.pageLocation}`))};export{Ie as compile};
