import h from"fs";import a from"path";import I from"esbuild";import{fileURLToPath as v}from"url";var _=e=>{if(typeof e=="string"||typeof e=="number")return e;if(typeof e!="function")throw"Cannot render non-functional elements.";let n=e(),t="";if(t+=`<${n.tag}`,Object.hasOwn(n,"getOptions")){let o=n.getOptions();for(let[c,r]of Object.entries(o))t+=` ${c}="${r}"`}if(!n.children)return t+="/>",t;t+=">";for(let o of n.children)t+=_(o);return t+=`</${n.tag}>`,t},R=({pageURL:e,head:n,renderingMethod:t,serverData:o=null,addPageScriptTag:c=!0})=>{let r='<meta name="viewport" content="width=device-width, initial-scale=1.0">';switch(t){case 1:r+='<script stype="module" rc="/client_ssr.js" defer="true"></script>';break;case 2:r+='<script stype="module" rc="/client_ssg.js" defer="true"></script>';break;case 3:r+='<script type="module" src="/client_csr.js" defer="true"></script>';break}c&&(r+=`<script type="module" src="${e===""?"":"/"}${e}/page.js" defer="true"></script>`);let l=n()();for(let d of l.children)r+=_(d);return o&&(r+=o),r};var w=(e,n=e)=>{let t=[],o=h.readdirSync(e,{withFileTypes:!0});for(let c of o)if(c.isDirectory()){let r=a.join(e,c.name),l=a.relative(n,r);t.push(l),t=t.concat(w(r,n))}return t},P=(e,n)=>{let t=e.find(o=>a.parse(o.name).name===n);return t||!1},m=process.cwd(),E=a.join(m,"./.elegance/dist"),F=a.join(m,"./.elegance/server"),L=v(import.meta.url),M=a.dirname(L),S=a.resolve(M,".."),O=a.resolve(S,"./src/client/client_csr.ts"),x=a.resolve(S,"./src/client/client_ssg.ts"),C=a.resolve(S,"./src/client/client_ssr.ts"),B=a.resolve(S,"./src/shared/bindServerElements.ts"),G=e=>{let n=[],t=[],o=[...w(e),""];for(let c of o){let r=a.join(m,e,c),l=h.readdirSync(r,{withFileTypes:!0}).filter(p=>p.name.endsWith(".js")||p.name.endsWith(".ts")),d=P(l,"page"),u=P(l,"info");if(!(!d&&!u)){if(u){if(!d)throw"Each info.js/ts file must have an accompanying page.js/ts file."}else throw"Each page.js/ts file must have an accompanying info.js/ts file.";n.push(d),t.push(u)}}return{pageFiles:n,infoFiles:t}};var A=async e=>{await I.build({bundle:!0,minify:e==="production",drop:e==="production"?["console","debugger"]:void 0,keepNames:!0,entryPoints:[O,C,x],outdir:E,format:"iife",platform:"node"})},U=async(e,n)=>{let t=e.map(o=>`${o.parentPath}/${o.name}`);await I.build({minify:n==="production",drop:n==="production"?["console","debugger"]:void 0,entryPoints:t,bundle:!0,outdir:F,loader:{".js":"js",".ts":"ts"},inject:[B],format:"esm",platform:"node"})},k=async(e,n)=>{let t=a.join(m,"./.elegance/server"),o=[...w(t),""],c=[];for(let r of o){let l=`${a.join(t,r,"/info.js")}`,d=a.join(m,n,r),u=e.find(N=>N.parentPath===d);if(!u)continue;let p=await import(l),{renderingMethod:b=1,metadata:i,executeOnServer:j,generateMetadata:D=1}=p;if(!i)throw`${r} does not export a function \`metadata\`. Info files must export a \`metadata\` function which resolves into a <head> element.`;if(typeof i!="function")throw`${r} The function \`metadata\` is not a function which resolves into a <head> element.`;c.push({renderingMethod:b,metadata:i,executeOnServer:j??null,generateMetadata:D,pageFilepath:`${u.parentPath}/${u.name}`,pageLocation:r})}return c},H=async(e,n)=>{for(let t of e){if(t.generateMetadata!==1)continue;let o=R({pageURL:t.pageLocation,head:t.metadata,addPageScriptTag:!1,renderingMethod:t.renderingMethod});h.writeFileSync(a.join(E,t.pageLocation,"metadata.html"),o,"utf-8")}},V=async(e,n)=>{},J=async(e,n)=>{for(let t of e){if(t.generateMetadata!==1)continue;let o=R({pageURL:t.pageLocation,head:t.metadata,addPageScriptTag:!0,renderingMethod:t.renderingMethod});h.writeFileSync(a.join(E,t.pageLocation,"metadata.html"),o,"utf-8")}},$=e=>`\x1B[38;2;238;184;68m${e}`,W=e=>`\x1B[38;2;0;0;0m${e}`,Q=e=>`\x1B[48;2;238;184;68m${e}`;var f=e=>`\x1B[1m${e}`,Y=e=>`\x1B[4m${e}`,g=e=>`\x1B[38;2;255;247;229m${e}`,y=e=>`\x1B[38;2;255;239;204m${e}`,q=e=>`\x1B[38;2;65;224;108m${e}`,s=(...e)=>console.log(e.map(n=>`${n}\x1B[0m`).join("")),de=async({pagesDirectory:e,buildOptions:n,environment:t})=>{s(f($(" -- Elegance.JS -- "))),s(g(`Beginning build at ${new Date().toLocaleTimeString()}..`)),s(""),t==="production"&&(s(" - ",Q(f(W(" NOTE ")))," : ",g("In production mode, no "),Y("console.log() "),g("statements will be shown on the client, and all code will be minified.")),s(""));let o=performance.now(),{pageFiles:c,infoFiles:r}=G(e);await U(r,t);let l=await k(c,e),d=l.filter(i=>i.renderingMethod===3),u=l.filter(i=>i.renderingMethod===1),p=l.filter(i=>i.renderingMethod===2);await I.build({entryPoints:[...u.map(i=>i.pageFilepath),...d.map(i=>i.pageFilepath)],minify:t==="production",drop:t==="production"?["console","debugger"]:void 0,bundle:!0,globalName:"page",outdir:E,loader:{".js":"js",".ts":"ts"},format:"esm",platform:"node"}),await H(u,t),await J(d,t),await V(p,t),await A(t);let b=performance.now();s(f($(" -- Elegance.JS -- "))),s(g(`Finished build at ${new Date().toLocaleTimeString()}.`)),s(q(f(`Created ${c.length} pages in ${Math.ceil(b-o)}ms!`))),s(""),s(g("  CSR:"));for(let i of d)s(y(`    - /${i.pageLocation}`));s(g("  SSR:"));for(let i of u)s(y(`    - /${i.pageLocation}`));s(g("  SSG:"));for(let i of p)s(y(`    - /${i.pageLocation}`))};export{de as compile};
