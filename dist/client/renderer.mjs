var d=h=>h.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();var u=class{constructor(){console.log("%cElegance renderer is loading..","font-size: 30px; color: #ffffaa"),this.renderTime=0,this.onRenderFinishCallbacks=[]}log(e){console.log(`%c${e}`,"font-size: 15px; color: #aaffaa;")}getDomTree(e){let n=[],t=e;for(;t;)n.push(`${t.tagName}`),t=t.parentElement;return n.reverse().join(" -> ")}getPageRenderTime(){return this.renderTime}onRenderFinish(e){this.log("Added render callback."),this.onRenderFinishCallbacks.push(e)}renderPage(e){let n=performance.now();this.log("Starting render.."),this.log("Emptying previous onRenderFinishCallbacks.."),this.onRenderFinishCallbacks=[];let t=document.createDocumentFragment(),r=globalThis.__ELEGANCE_SERVER_DATA__,o=globalThis.eleganceRouter,i=globalThis.eleganceStateController;if(!o)throw"Cannot render page without router.";if(!i)throw"Cannot render page without stateController.";let s=e({router:o,state:i,renderer:this,serverData:r?r.data:void 0}),a=this.createElement(s,t,!0),c=performance.now()-n;if(this.log(`Page fully rendered after: ${c}ms`),!a)throw"The first element of a page may never be null.";t.appendChild(a),document.documentElement.replaceChild(a,document.body),this.renderTime=c,this.log("Calling on render finish callbacks..");for(let l of this.onRenderFinishCallbacks)l();o.setPopState()}buildElement(e){if(typeof e=="string")return e;if(e instanceof Promise)throw"Asynchronous elements are not supported, consider using a suspense element.";if(Array.isArray(e))throw"Array elements are not supported.";if(typeof e!="function")throw`Cannot build a non-functional element, got ${e}.`;return e()}assignPropertyToHTMLElement(e,n,t){if(!(e instanceof HTMLElement))throw new Error(`Provided elementInDocument is not a valid HTML element. Got: ${e}.`);if(n==="style"&&typeof t=="object"){Object.assign(e.style,t);return}else if(n.toLowerCase()in e&&n.startsWith("on")){e[n.toLowerCase()]=t;return}else if(n in e){e[n]=t;return}else if(n==="class"){e.className=t;return}else if(typeof t=="function"){e.setAttribute(d(n),t());return}e.setAttribute(d(n),t)}processElementOptions(e,n,t){if(!Object.hasOwn(e,"getOptions"))return;let r=e,o=r.getOptions();if(o){for(let i in o)if(Object.hasOwn(o,i)){let s=o[i];if(Object.hasOwn(s,"ids")&&Object.hasOwn(s,"update")&&Object.hasOwn(s,"scope")){if(t)continue;this.processOptionAsObserver(s,n,r,i)}this.assignPropertyToHTMLElement(n,i,s)}}}anyToString(e){if(typeof e=="function")return e.toString();if(e instanceof Promise)return"Promise { <state> }";if(e===null)return"null";if(e===void 0)return"undefined";if(typeof e=="number"||typeof e=="string"||typeof e=="boolean")return JSON.stringify(e);if(Array.isArray(e))return`[${e.map(n=>this.anyToString(n)).join(", ")}]`;if(typeof e=="object"){let n=e.constructor.name;return n!=="Object"?`${n} { ${Object.entries(e).map(([t,r])=>`${t}: ${this.anyToString(r)}`).join(", ")} }`:`{ ${Object.entries(e).map(([t,r])=>`${t}: ${this.anyToString(r)}`).join(", ")} }`}return String(e)}createElement(e,n,t){let r;if(typeof e=="boolean")return null;try{r=this.buildElement(e)}catch(i){throw`Failed to build element ${this.anyToString(e)}. Encountered an error: ${i}`}if(typeof r=="string"){let i=document.createTextNode(r);return n.appendChild(i),i}let o=document.createElement(r.tag);if(this.processElementOptions(r,o,!1),t){let i=r.children.length;for(let s=0;s<i;s++){let a=r.children[s];a&&this.createElement(a,o,!0)}}if(n.appendChild(o),r.onMount){let i=e;r.onMount({builtElement:r,elementInDocument:o,buildableElement:i})}return o}updateElement(e,n){let t=this.buildElement(n),r=e.parentElement;if(!r){let s=this.getDomTree(e);throw`Cannot update element ${e.tagName}, since it does not have a parent. Dom Tree: ${s}`}if(typeof t=="string"){let s=document.createTextNode(t);return r.replaceChild(e,s),s}let o=document.createElement(t.tag);this.processElementOptions(t,o,!1);let i=t.children.length;for(let s=0;s<i;s++){let a=t.children[s];a&&this.createElement(a,o,!0)}return e.parentElement.replaceChild(o,e),o}processOptionAsObserver(e,n,t,r){let{ids:o,scope:i,update:s}=e,a=[],c=globalThis.eleganceStateController;for(let l=0;l<o.length;l++){let f=o[l],g=i==="local"?c.get(f):c.getGlobal(f);a.push(g.get());let b=async m=>{a[l]=m,this.assignPropertyToHTMLElement(n,r,s(...a))};g.observe(b)}this.assignPropertyToHTMLElement(n,r,s(...a))}};export{u as Renderer};
